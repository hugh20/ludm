(function(){var template='<section class="mod-load-more">\r\n    <div class="mlm-status-loading">\r\n        <div class="mlm-dots">\r\n            <span class="mlm-dot"></span>\r\n            <span class="mlm-dot"></span>\r\n            <span class="mlm-dot"></span>\r\n        </div>\r\n        <p class="mlm-info">\u563f\u54bb\u563f\u54bb\u52a0\u8f7d\u4e2d</p>\r\n    </div>\r\n    <div class="mlm-status-over">\r\n        \u5ba2\u5b98\uff0c\u4eba\u5bb6\u5df2\u7ecf\u6ca1\u6709\u90a3\u4e2a\u7684\u5566~~\r\n    </div>\r\n    <div class="mlm-status-again">\r\n        <a class="mlm-btn-again">\r\n            \u518d\u5237\u4e00\u6b21\uff01>_<\r\n        </a>\r\n    </div>\r\n</section>',
styles="html {\n  font-size: 20px; }\n\nhtml {\n  font-size: 10px;\n  overflow-x: hidden; }\n  @media screen and (min-width: 320px) {\n    html {\n      font-size: 17px; } }\n  @media screen and (min-width: 360px) {\n    html {\n      font-size: 19px; } }\n  @media screen and (min-width: 375px) {\n    html {\n      font-size: 20px; } }\n  @media screen and (min-width: 414px) {\n    html {\n      font-size: 22px; } }\n\nbody {\n  font-size: 14px; }\n\n.mod-load-more {\n  text-align: center;\n  padding-top: 0.95rem;\n  padding-bottom: 0.95rem;\n  color: #9a9a9a;\n  font-size: 0.6rem; }\n  .mod-load-more .mlm-status-loading .mlm-dots {\n    text-align: center;\n    display: inline-block; }\n    .mod-load-more .mlm-status-loading .mlm-dots span.mlm-dot {\n      display: inline-block;\n      vertical-align: middle;\n      width: 5px;\n      height: 5px;\n      background-color: #7a8090;\n      border-radius: 50%;\n      margin: 0 3px; }\n      .mod-load-more .mlm-status-loading .mlm-dots span.mlm-dot:nth-of-type(1) {\n        background-color: #7a8090;\n        -webkit-animation: mod-load-more_dot_move 1s ease-in infinite; }\n      .mod-load-more .mlm-status-loading .mlm-dots span.mlm-dot:nth-of-type(2) {\n        background-color: rgba(122, 128, 144, 0.6);\n        -webkit-animation: mod-load-more_dot_move 1s ease-in 0.3s infinite; }\n      .mod-load-more .mlm-status-loading .mlm-dots span.mlm-dot:nth-of-type(3) {\n        background-color: rgba(122, 128, 144, 0.3);\n        -webkit-animation: mod-load-more_dot_move 1s ease-in 0.7s infinite; }\n\n@-webkit-keyframes mod-load-more_dot_move {\n  0% {\n    opacity: 1; }\n  100% {\n    opacity: 0.5; } }\n  .mod-load-more .mlm-status-loading p.mlm-info {\n    display: inline-block;\n    vertical-align: middle; }\n  .mod-load-more .mlm-status-over {\n    display: none; }\n  .mod-load-more .mlm-status-again {\n    display: none;\n    width: 100%; }\n    .mod-load-more .mlm-status-again a.mlm-btn-again {\n      display: block;\n      margin: 0 auto;\n      width: 7.5rem;\n      height: 2.25rem;\n      background-color: #666;\n      color: white;\n      font-size: 0.75rem;\n      height: 2.25rem;\n      line-height: 2.25rem; }\n";
function LoadMore(para){var that=this;that.init(para)}LoadMore.prototype={"init":function(para){var that=this;para=para||{};if(!para.listElem)return;that.createStyles();that.listElem=para.listElem;that.scrollElem=para.scrollElem||document.body;that.scrollLimit=para.scrollLimit||300;that.pageIndex=para.pageIndex===undefined?1:para.pageIndex;that.pageSize=para.pageSize||10;that.onLoading=para.onLoading;that.onEnough=para.onEnough;that.onNotEnough=para.onNotEnough;that.itemUniqueAttr=para.itemUniqueAttr;
that.itemHashAttr=para.itemHashAttr;that.dom=$(template);that.dom.$status_loading=that.dom.find(".mlm-status-loading");that.dom.$status_over=that.dom.find(".mlm-status-over");$(that.listElem).after(that.dom);that.bindScroll()},"createStyles":function(){if(!LoadMore.styles){LoadMore.styles=$("<style></style>").html(styles);$("body").append(LoadMore.styles)}},"changeStatusToNormal":function(){var that=this;that.dom.hide();that.isLoading=false;that.isLoadOver=false},"changeStatusToLoading":function(){var that=
this;that.dom.show();that.dom.$status_loading.show();that.dom.$status_over.hide();that.isLoading=true;that.isLoadOver=true},"changeStatusToOver":function(){var that=this;that.dom.show();that.dom.$status_loading.hide();that.dom.$status_over.show();that.isLoading=false;that.isLoadOver=true},"bindScroll":function(){var that=this;var scrollElem=that.scrollElem,box=scrollElem==document.body?document.documentElement:scrollElem,tar=scrollElem==document.body?window:scrollElem,limit=that.scrollLimit;tar.addEventListener("scroll",
function(){var scrollTop=box.scrollTop||scrollElem.scrollTop||window.scrollY||window.pageYOffset;if(box.clientHeight+scrollTop>=scrollElem.scrollHeight-limit)that.onTouchLimit()})},"onTouchLimit":function(){var that=this;var callback=that.onLoading;if(!that.isLoadOver&&callback&&typeof callback=="function"&&!that.isLoading)if(callback.call(that)!==false)that.changeStatusToLoading()},"appendChild":function(children){var that=this,itemUniqueAttr=that.itemUniqueAttr,itemHashAttr=that.itemHashAttr;if(typeof children===
"string")children=children.replace(/(^\s+|\s+$)/g,"");if(!children){if(that.onNotEnough&&!that.onNotEnough(children)){that.changeStatusToNormal();return}that.changeStatusToOver();return}var $listElem=$(that.listElem),$children=$(children),childType=$children.attr("tagName");if(!childType||!childType.toLowerCase||childType.toLowerCase()!=="li"){$children=$children.filter("li");if(!$children.length)$children=$children.find("li")}$children.each(function(){if(itemUniqueAttr){var $item=$(this),attrValue=
$item.attr(itemUniqueAttr),$sameItem=$listElem.find("["+itemUniqueAttr+'="'+attrValue+'"]');if($sameItem&&$sameItem.length){if(!itemHashAttr||$item.attr(itemHashAttr)!==$sameItem.attr(itemHashAttr))$sameItem.replaceWith($item);return}}$listElem.append(this)});if($children.length)that.pageIndex++;if($children.length<that.pageSize){if(that.onNotEnough&&!that.onNotEnough(children)){that.changeStatusToNormal();return}that.changeStatusToOver()}else{if(that.onEnough&&!that.onEnough(children)){that.changeStatusToOver();
return}that.changeStatusToNormal()}}};window.LoadMore=LoadMore})();
(function(){var LS={get:function(key){try{return window.localStorage?window.localStorage.getItem(key):false}catch(e){console.log("\u8bfb\u53d6 LocalStorage \u5f02\u5e38\uff1a",e);return false}},set:function(key,data){try{return window.localStorage?window.localStorage.setItem(key,data):false}catch(e){console.log("\u5199\u5165 LocalStorage \u5f02\u5e38\uff1a",e);return false}}};var LocalHistory=BIU.Model.extend({init:function(){var self=this;self.read()},clear:function(exceptIds){var self=this,data=
self.dataComic,newList=[];exceptIds=exceptIds||[];data.forEach(function(d){if(exceptIds.indexOf(String(d.id))>=0)newList.push(d)});self.dataComic=newList;self.save()},read:function(){var self=this,raw=LS.get(self.lsKey)||"[]",data=JSON.parse(raw);if(Object.prototype.toString.apply(data)!=="[object Array]")self.clear();self.dataComic=data;raw=LS.get(self.lsKey+"_CHAPTER")||"{}";data=JSON.parse(raw);self.dataChapter=data;return true},save:function(){var self=this,data=self.dataComic;if(!data)return false;
self.clean();self.trigger("onSave");var raw=JSON.stringify(data),res=LS.set(self.lsKey,raw);data=self.dataChapter;raw=JSON.stringify(data);return LS.set(self.lsKey+"_CHAPTER",raw)&&res},sort:function(){var self=this,data=self.dataComic;return data.sort(function(a,b){return-(a.time-b.time)})},clean:function(){var self=this,data=self.dataComic;if(data.length<self.limit)return;var list=self.sort(),ids=[];for(var i=list.length-self.limit,l=list.length;i<l;i++)ids.push(list[i]);return self.deleteComicRecord(ids)},
lsKey:"MAC_LOCAL_HISTORY",limit:50,loadComicRecord:function(id){var self=this,data=self.dataComic;id=String(id);for(var i=0,d;d=data[i];i++)if(String(d.id)==id)return d;return null},saveComicRecord:function(id,seq,cid,title,artist,cover){var self=this,data=self.dataComic,d=self.loadComicRecord(id),oldTitle=d&&d.title,oldArtist=d&&d.artist,oldCover=d&&d.cover;if(!d){d={};data.push(d)}d.time=(new Date).getTime();d.id=id;d.seq=seq;d.cid=cid;d.title=title||oldTitle||"..";d.artist=artist||oldArtist||"..";
d.cover=cover||oldCover||"";self.save();return true},deleteComicRecord:function(ids){var self=this,data=self.dataComic;if(!ids.length)ids=[ids];ids.forEach(function(id){var deleted=self.loadComicRecord(id),pos=data.indexOf(deleted);if(pos<0)return;data.splice(pos,1)});self.save();return true},sync:function(cb){var self=this,data=self.dataComic;if(!data||!data.length)return;self._syncServerTime(function(timeSpan){self._uploadToServer(timeSpan,function(res){var status=res&&res.status||0,data=res&&res.data||
{},exceptIds=data["fail_ids"]||[];if(status==2){self.clear(exceptIds);cb&&cb(res)}else console.error("\u9605\u8bfb\u8bb0\u5f55\u540c\u6b65\u5931\u8d25: ",status)})})},_uploadToServer:function(timeSpan,cb){var self=this,data=self.dataComic,tmp=[],startTime=null;for(var id in data){var d=data[id],time=(d.time/1E3|0)+timeSpan;tmp.push(d.id+"-"+d.cid+"-"+d.seq+"-"+time);if(time<startTime||startTime===null)startTime=time}ek.ajax({url:"/Bookshelf/updateReadHistory",type:"post",data:{startTime:startTime,
history:tmp.join(",")},success:function(res){cb&&cb(res)}})},_syncServerTime:function(cb){ek.ajax({url:"/Ajax/getTimeStamp",type:"post",success:function(res){var status=res&&res.status||null,data=res&&res.data||{},stamp=data.stamp||0,localStamp=(new Date).getTime()/1E3|0;cb&&cb(status===2?stamp-localStamp:0)}})},loadChapterProgress:function(id,cid){var self=this,data=self.dataChapter,cs=data[id]||{},cur=cs[cid]||1;return cur},saveChapterProgress:function(id,cid,cur){var self=this,data=self.dataChapter,
cs=data[id]={};cs[cid]=cur;self.save()}});window.LocalHistory=LocalHistory;if(typeof module!="undefined"&&module.exports)module.exports=LocalHistory})();
Zepto(function(){new BackToTop;var md_UserInfo=new BIU.Model({name:"md_UserInfo",load:function(id){var that=this;ek.ajax({url:"/comic/getUserInfo",data:{id:id},success:function(res){that.set(res)}})},pageReady:function(){var that=this;that.load(that.page.id);window.addEventListener("popstate",function(){that.load(that.page.id)})}});var md_LocalHistory=new LocalHistory({name:"md_LocalHistory",pageReady:function(){var that=this;window.addEventListener("popstate",function(){that.read()})}});var vw_Sequence=
new BIU.View({name:"vw_Sequence",events:{"click #btn_sequence":function(e){var $target=$(e.target).closest("#btn_sequence");if($target.hasClass("reverse")){$target.removeClass("reverse");$("#sequence_text").html("\u9006\u5e8f");$(".chapter-list-box").addClass("reverse")}else{$target.addClass("reverse");$("#sequence_text").html("\u6b63\u5e8f");$(".chapter-list-box").removeClass("reverse")}}}});var vw_ChapterList=new BIU.View({name:"vw_ChapterList",listen:{"md_UserInfo":function(res){var $list_box=
$(".chapter-list-box"),$list_chapterAll=$(".chapter-list-box .chapter-list");if(res&&res.status==2){var chapterIds=res.data.bought_info&&res.data.bought_info.bought_chapter_ids;var comicState=res.data.bought_info&&res.data.bought_info.bought_comic_state;if(chapterIds.length>0)for(var i=0,j=chapterIds.length;i<j;i++)$list_chapterAll.find('a[data-cid="'+chapterIds[i]+'"]').removeClass("lock");else if(comicState==2)$list_chapterAll.find("a[data-cid]").removeClass("lock");if($list_box.attr("data-vip-free")==
2&&res.data.is_vip_user)$list_chapterAll.find("a.lock").removeClass("lock");var cloudSeq=res.data.seq_no;if(cloudSeq>0){$list_chapterAll.find("a[data-seq]").removeClass("now");$list_chapterAll.find('a[data-seq="'+cloudSeq+'"]').addClass("now")}}else if(res&&res.status==-99){var localSeq=md_LocalHistory.loadComicRecord(this.page.id);if(localSeq){$list_chapterAll.find("a[data-seq]").removeClass("now");$list_chapterAll.find('a[data-seq="'+localSeq.seq+'"]').addClass("now")}}}}});pg_ChapterList.addModel(md_UserInfo);
pg_ChapterList.addModel(md_LocalHistory);pg_ChapterList.addView(vw_Sequence);pg_ChapterList.addView(vw_ChapterList);pg_ChapterList.pageReady()});
